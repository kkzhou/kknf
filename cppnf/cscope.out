cscope 16 e:\source\kknf\cppnf               0000024111
	@address.hpp

19 #iâdeà
__ADDRES_HPP__


20 
	#__ADDRES_HPP__


	)

22 
Çnme¥aû
 
	gZXBNF
 {

24 şas 
	cAdd»ss
 {

25 
	gpublic
:

26 
Add»ss
(){};

27 
S‘Add»ss
(*
¡r
, 
pÜt
) {

29 
sockaddr_š
 
	gaddr
;

30 
sockËn_t
 
	gaddr_Ën
;

31 
boŞ
 
	gv®id
 = 
çl£
;

33 
mem£t
(&
addr
, 0, (
addr_
));

34 
	gaddr
.
	gsš_Ën
 = (
addr_
) - 8;

35 
	gaddr
.
	gsš_çmy
 = 
PF_INET
;

36 
	gaddr
.
	gsš_pÜt
 = 
htÚs
(
pÜt
);

38 ià(
š‘_©Ú
(
¡r
, &
addr
.
sš_addr
) != 1) {

41 
	gaddr_Ën
 = (
sockaddr
);

42 
	gaddr
.
S‘Add»ss
(
addr
, 
addr_Ën
);

46 
S‘Add»ss
(
sockaddr_š
 
addr
, 
sockËn_t
 
addr_Ën
) {

47 
	gaddr_
 = 
addr
;

48 
	gaddr_Ën_
 = 
addr_Ën
;

51 
	gAdd»ss
& 
	gİ”©Ü
=(
Add»ss
 &
addr
) {

52 
addr_
 = 
addr
;

53 
	gaddr_Ën_
 = 
addr_Ën
;

54  *
	gthis
;

57 
šlše
 
sockaddr_š
 
addr
(ècÚ¡ {  
	gaddr_
; };

58 
šlše
 
sockËn_t
 
addr_Ën
(ècÚ¡ {  
	gaddr_Ën_
; };

60 
	g´iv©e
:

61 
sockaddr_š
 
addr_
;

62 
sockËn_t
 
	gaddr_Ën_
;

	@async_http_socket.hpp

1 #iâdeà
__ASYNC_HTTP_SOCKET_HPP__


2 
	#__ASYNC_HTTP_SOCKET_HPP__


	)

5 
	~"async_tı_sock‘.hµ
"

7 
Çme¥aû
 
	gZXBNF
 {

9 şas 
	cHTTPLi¡’Sock‘
 : 
public
 
AsyncTCPLi¡’Sock‘
 {

10 
public
:

11 
HTTPLi¡’Sock‘
() {};

12 ~
HTTPLi¡’Sock‘
() {};

14 
vœtu®
 
AsyncTCPD©aSock‘
* 
MakeNewSock‘
(
fd
);

17 şas 
	cHTTPSock‘
 : 
public
 
AsyncTCPD©aSock‘
 {

18 
public
:

19 
vœtu®
 
Mes§gize
(
Bufãr
 **
msg
, *
msg_Ën
);

	@async_lv_socket.hpp

1 #iâdeà
__ASYNC_LV_SOCKET_HPP__


2 
	#__ASYNC_LV_SOCKET_HPP__


	)

5 
	~"async_tı_sock‘.hµ
"

7 
Çme¥aû
 
	gZXBNF
 {

9 şas 
	cLVLi¡’Sock‘
 : 
public
 
AsyncTCPLi¡’Sock‘
 {

10 
public
:

11 
LVLi¡’Sock‘
() {};

12 ~
TCPLVLi¡’Sock‘
() {};

14 
vœtu®
 
AsyncTCPD©aSock‘
* 
MakeNewSock‘
(
fd
);

17 şas 
	cLVSock‘
 : 
public
 
AsyncTCPD©aSock‘
 {

18 
public
:

19 
vœtu®
 
Mes§gize
(
Bufãr
 **
msg
, *
msg_Ën
);

	@async_socket.cpp

19 
	~"ut.hµ
"

20 
	~"async_sock‘.hµ
"

22 
Çme¥aû
 
	gZXBNF
 {

25 
	gAsyncTCPLi¡’Sock‘
::
AsyncTCPLi¡’Sock‘
(
Add»ss
 &
addr
) {

27 
ENTERING
;

28 
	g»t
 = 
bšd
(
sock‘
(), (
sockaddr
*)&(
addr
.addr()),‡ddr.
addr_Ën
());

29 ià(
	g»t
 < 0) {

30 
Inv®id©e
();

31 
	gLEAVING2
;

34 
	g»t
 = 
li¡’
(
sock‘
(), 1024);

35 ià(
	g»t
 < 0) {

36 
Inv®id©e
();

37 
	gLEAVING2
;

41 
	gLEAVING
;

44 
	gAsyncTCPLi¡’Sock‘
::
OnAcû±abË
() {

46 
ENTERING
;

47 
sockaddr_š
 
	gÃw_addr
;

48 
sockËn_t
 
	gaddr_Ën
;

49 
	gÃwsk
 = 
acû±
(
sock‘_
, (
sockaddr
*)&
Ãw_addr
, &
addr_Ën
);

50 ià(
	gÃw_sk
 < 0) {

51 ià(
	g”ºo
 !ğ
EAGAIN
 || 
”ºo
 !ğ
EINTR
) {

52 
LEAVING2
;

55 
	gLEAVING2
;

58 
	gLEAVING
;

59  
	gÃw_sk
;

63 
AsyncTCPD©aSock‘
* 
	gAsyncTCPLVLi¡’Sock‘
::
MakeNewSock‘
(
fd
) {

65  
Ãw
 
LVSock‘
(
fd
);

69 
AsyncTCPD©aSock‘
* 
	gAsyncTCPHTTPLi¡’Sock‘
::
MakeNewSock‘
(
fd
) {

71  
Ãw
 
HTTPSock‘
(
fd
);

	@async_socket.hpp

19 #iâdeà
__ASYNC_SOCKET_HPP__


20 
	#__ASYNC_SOCKET_HPP__


	)

22 
	~"bufãr.hµ
"

24 
Çme¥aû
 
	gZXBNF
 {

27 şas 
	cAsyncSock‘
 {

28 
	g´Ùeùed
:

30 
AsyncSock‘
(è:
sock‘_
(-1), 
”rÜ_
(
çl£
){};

31 
	gvœtu®
 ~
AsyncSock‘
(è{ 
şo£
(
sock‘_
); };

32 
	g´iv©e
:

34 
AsyncSock‘
(AsyncSocket&){};

35 
	gAsyncSock‘
& 
	gİ”©Ü
=(
AsyncSock‘
&){};

36 
	gpublic
:

37 
Inv®id©e
(è{ 
”rÜ_
 = 
Œue
; };

39 
šlše
 
sock‘
(è{  
	gsock‘_
; };

40 
šlše
 
£t_sock‘
(
sock‘
è{ 
	gsock‘_
 = socket; };

41 
šlše
 
boŞ
 
”rÜ
(è{  
	g”rÜ_
; };

43 
	g´iv©e
:

44 
boŞ
 
”rÜ_
;

45 
	gsock‘_
;

	@async_tcp_socket.hpp

1 #iâdeà
__ASYNC_TCP_SOCKET_HPP__


2 
	#__ASYNC_TCP_SOCKET_HPP__


	)

4 
	~"async_sock‘.hµ
"

6 
Çme¥aû
 
	gZXBNF
 {

8 şas 
	cAsyncTCPSock‘
 : 
public
 
AsyncSock‘
 {

9 
´Ùeùed
:

11 
AsyncTCPSock‘
() {};

12 
BšdOn
(
Add»ss
 &
addr
);

13 
	g´iv©e
:

15 
AsyncTCPSock‘
(
AsyncTCPSOck‘
&){};

16 
	gAsyncTCPSock‘
& 
	gİ”©Ü
=(
AsyncTCPSock‘
&){};

19 şas 
	cAsyncTCPLi¡’Sock‘
 : 
public
 
AsyncTCPSock‘
 {

20 
´Ùeùed
:

21 
AsyncTCPLi¡’Sock‘
() {};

22 ~
AsyncTCPLi¡’Sock‘
() {};

23 
Lš¡’
();

24 
OnAcû±abË
();

25 
vœtu®
 
AsyncTCPD©aSock‘
* 
MakeNewSock‘
(
fd
);

26 
	g´iv©e
:

30 şas 
	cAsyncTCPD©aSock‘
 : 
public
 
AsyncTCPSock‘
 {

31 
´Ùeùed
:

32 
AsyncTCPD©aSock‘
(){};

33 ~
AsuncTCPD©aSock‘
(){};

34 
AsyncTCPD©aSock‘
(
fd
è{ 
£t_sock‘
(fd); };

35 
	gpublic
:

37 
OnWr™abË
();

38 
OnE¼Ü
();

39 
OnR—dabË
();

40 
	gpublic
:

42 
S’dMes§ge
(
Bufãr
 *
msg
, 
msg_Ën
);

43 
CÚÃùTo
(
Add»ss
 &
to
, 
Add»sss
, &
äom
);

44 
CÚÃùTo
(
Add»ss
 &
to
);

47 
vœtu®
 
Mes§gize
(
Bufãr
 **
msg
, *
msg_Ën
) = 0;

49 
	g´iv©e
:

50 
Bufãr
 *
msg_š_»cv_
;

51 
	gmsg_size_
;

53 
Bufãr
 *
	g£nd_bufãr_li¡_
;

	@async_udp_socket.hpp

19 #iâdeà
__ASYNC_UDP_SOCKET_HPP__


20 
	#__ASYNC_UDP_SOCKET_HPP__


	)

23 
Çme¥aû
 
	gZXBNF
 {

25 şas 
	cUDPSock‘
 : 
public
 
AsyncSock‘
 {

26 
public
:

27 
	sUDPMes§ge
 {

28 
Bufãr
 *
d©a_
;

29 
Add»ss
 
	gaddr_
;

31 
	gpublic
:

32 
BšdOn
(
Add»ss
 &
addr
);

33 
OnR—dabË
();

34 
OnWr™abË
();

35 
	gpublic
:

36 
S’dMes§ge
(
Bufãr
 *
msg
, 
msg_Ën
);

37 
Mes§gize
(
Bufãr
 **
msg
, *
msg_Ën
) = 0;

39 
	g´iv©e
:

40 
UDPMes§ge
 *
msg_š_»cv_
;

41 
UDPMes§ge
 *
	g£nd_msg_li¡_
;

	@buffer.hpp

18 #iâdeà
__BUFFER_HPP__


19 
	#__BUFFER_HPP__


	)

21 
	~<deque
>

22 
	~<io¡»am
>

24 
Çme¥aû
 
	gZXBNF
 {

26 şas 
	cBufãr
 {

27 
	gpublic
:

28 
Bufãr
(*
¡¬t
, 
Ëngth
) {

29 
	g¡¬t_
 = 
¡¬t
;

30 
	gËngth_
 = 
Ëngth
;

31 
	gh—d_
 = 0;

32 
	g_
 = 0;

35 
šlše
 * 
¡¬t
(è{  
	g¡¬t_
; };

36 
šlše
 
Ëngth
(è{  
	gËngth_
; };

37 
šlše
 &
h—d
(è{  
	gh—d_
; };

38 
šlše
 &

(è{  
	g_
;};

39 
šlše
 
	gBufãr
* &
Ãxt
(è{  
	gÃxt_
; };

40 
šlše
 
	gBufãr
* &
´ev
(è}  
	g´ev_
; };

42 
	g´iv©e
:

43 *
¡¬t_
;

44 
	gh—d_
;

45 
	g_
;

46 
	gËngth_
;

47 
Bufãr
 *
	gÃxt_
;

48 
Bufãr
 *
	g´ev_
;

49 
	g´iv©e
:

51 
	$Bufãr
(
Bufãr
&è{
	}
};

52 
	gBufãr
& 
	gİ”©Ü
=(
Bufãr
&) {};

57 şas 
	cMemPoŞ
 {

58 
	mpublic
:

59 
	$MemPoŞ
(
Ïrge_block_size
 = 2*1024*1024,

60 
Ïrge_block_num
 = 100,

61 
sm®l_block_size
 = 4*1024,

62 
sm®l_block_num
 = 1000)

63 :
	`idË_Ïrge_blocks_
(0),

64 
	$idË_sm®l_blocks_
(0) {

66 
Ïrge_block_size_
 = 
Ïrge_block_size
;

67 
Ïrge_block_num_
 = 
Ïrge_block_num
;

68 
sm®l_block_size_
 = 
sm®l_block_size
;

69 
sm®l_block_num_
 = 
sm®l_block_num
;

71 
Ïrge_poŞ_
 = 
	`m®loc
(
Ïrge_block_size_
 * 
Ïrge_block_num_
);

72 
sm®l_poŞ_
 = 
	`m®loc
(
sm®l_block_size_
 * 
sm®l_block_num_
);

75 
i
 = 0; i < 
Ïrge_block_num_
; i++) {

76 
idË_Ïrge_blocks_
.
	`push_back
(
Ïrge_poŞ_
 + 
i
 * 
Ïrge_block_size_
);

78 
i
 = 0; i < 
Ïrge_block_num_
; i++) {

79 
idË_Ïrge_blocks_
.
	`push_back
(
Ïrge_poŞ_
 + 
i
 * 
Ïrge_block_size_
);

83 
šlše
 
	$De¡roy
() {

84 
d–‘e
[] 
Ïrge_poŞ_
;

85 
d–‘e
[] 
sm®l_poŞ_
;

86 
	}
};

88 
šlše
 
Bufãr
* 
	$G‘Sm®lBlock
() {

90 ià(
idË_sm®l_blocks_
.
	`em±y
()) {

94 
Bufãr
 *
buf
 = 
Ãw
 
	`Bufãr
(
idË_sm®l_blocks_
.
	`äÚt
(), 
sm®l_block_size_
);

95 
idË_sm®l_blocks_
.
	`pİ_äÚt
();

96  
buf
;

97 
	}
};

99 
šlše
 
Bufãr
* 
	$G‘L¬geBlock
() {

101 ià(
idË_Ïrge_blocks_
.
	`em±y
()) {

105 
Bufãr
 *
buf
 = 
Ãw
 
	`Bufãr
(
idË_Ïrge_blocks_
.
	`äÚt
(), 
Ïrge_block_size_
);

106 
idË_Ïrge_blocks_
.
	`pİ_äÚt
();

107  
buf
;

108 
	}
};

110 
šlše
 
	$PutBlock
(
Bufãr
 *
buf
) {

112 
	`as£¹
(
buf
);

114 ià(
buf
->
	`Ëngth
(è=ğ
Ïrge_block_size_
) {

115 
	`as£¹
((
buf
->
	`¡¬t
(è- 
Ïrge_poŞ_
è% 
Ïrge_block_size_
 == 0);

116 
idË_Ïrge_blocks_
.
	`push_äÚt
(
buf
->
	`¡¬t
());

117 } ià(
buf
->
	`Ëngth
(è=ğ
sm®l_block_size_
) {

118 
	`as£¹
((
buf
->
	`¡¬t
(è- 
sm®l_poŞ_
è% 
sm®l_block_size_
 == 0);

119 
idË_sm®l_blocks_
.
	`push_äÚt
(
buf
->
	`¡¬t
());

121 
	`as£¹
(
çl£
);

123 
d–‘e
 
buf
;

124 
	}
};

126 
šlše
 
	$Stus
() {

128 
	}
};

130 
šlše
 
	$sm®l_block_size
(è{  
sm®l_block_num_
; 
	}
};

131 
šlše
 
	$Ïrge_block_size
(è{  
Ïrge_block_size_
; 
	}
};

133 
	g´iv©e
:

135 *
Ïrge_poŞ_
;

137 
	g¡d
::
deque
<*> 
idË_Ïrge_blocks_
;

138 
	gÏrge_block_size_
;

139 
	gÏrge_block_num_
;

142 *
	gsm®l_poŞ_
;

144 
	g¡d
::
deque
<*> 
idË_sm®l_blocks_
;

145 
	gsm®l_block_size_
;

146 
	gsm®l_block_num_
;

149 
	$MemPoŞ
(
MemPoŞ
 &è{
	}
};

150 
	gMemPoŞ
& 
	gİ”©Ü
=(
MemPoŞ
&) {};

	@event.hpp

19 #iâdeà
__EVENT_HPP__


20 
	#__EVENT_HPP__


	)

22 
Çme¥aû
 
	gZXBNF
 {

24 şas 
	cEv’t
 {

25 
	gpublic
:

30 (*
Ev’tC®lback
)(
	tEv’t
*, *);

31 
Ev’t
(
fd
, 
Ev’tC®lback
 
cb
, *
¬g
)

32 : 
fd_
(
fd
),

33 
ev’ts_
(0),

34 
cb_
(
cb
),

35 
cb_¬g
(
¬g
){};

37 ~
Ev’t
() {};

39 
šlše
 &
fd
(è{  
	gfd_
; };

40 
šlše
 
£t_»ad_ev’t
() {

41 
	gŞd
 = 
ev’ts_
;

42 
	gev’ts_
 |ğ
EVENT_READ
;

43  
	gŞd
;

45 
šlše
 
£t_»ad_ev’t
() {

46 
	gŞd
 = 
ev’ts_
;

47 
	gev’ts_
 |ğ
EVENT_READ
;

48  
	gŞd
;

50 
šlše
 
£t_”rÜ_ev’t
() {

51 
	gŞd
 = 
ev’ts_
;

52 
	gev’ts_
 |ğ
EVENT_ERROR
;

53  
	gŞd
;

55 
šlše
 
£t_şo£_ev’t
() {

56 
	gŞd
 = 
ev’ts_
;

57 
	gev’ts_
 |ğ
EVENT_CLOSE
;

58  
	gŞd
;

60 
šlše
 
boŞ
 
is_»adabË
(è{  
	gev’ts_
 & 
	gEVENT_READ
; };

61 
šlše
 
boŞ
 
is_wr™abË
(è{  
	gev’ts_
 & 
	gEVENT_WRITE
; ;}

62 
šlše
 
boŞ
 
is_şo£d
(è{  
	gev’ts_
 & 
	gEVENT_CLOSE
; };

63 
šlše
 
boŞ
 
is_”rÜ
(è{  
	gev’ts_
 & 
	gEVENT_ERROR
; };

65 
šlše
 
g‘_•Şl_ev’ts
() {

66 
	gev’ts
 = 0;

68 ià(
is_»adabË
()) {

69 
	gev’ts
 |ğ
EPOLLIN
;

71 ià(
is_wr™abË
()) {

72 
	gev’ts
 |ğ
EPOLLOUT
;

74 ià(
is_şo£d
()) {

75 
	gev’ts
 |ğ
EPOLLHUP
;

77 ià(
is_”rÜ
()) {

78 
	gev‘ns
 |ğ
EPOLLERR
;

80  
	gev’ts
;

82 
šlše
 
£t_•Şl_ev’ts
(
ev’ts
) {

83 
	gev’ts_
 = 0;

84 ià(
	gev’ts
 & 
	gEPOLLIN
) {

85 
£t_»ad_ev’t
();

87 ià(
	gev’ts
 & 
	gEPOLLOUT
) {

88 
£t_wr™e_ev’t
();

90 ià(
	gev’ts
 & 
	gEPOLLERR
) {

91 
£t_”rÜ_ev’t
();

93 ià(
	gev’ts
 & 
	gEPOLLHUP
) {

94 
£t_şo£_ev’t
();

97 
HªdËr
() {

98 
as£¹
(
cb_
);

99 
as£¹
(
cb_¬g_
);

100  
cb_
(
this
, 
cb_¬g_
);

103 
	g´iv©e
:

104 
fd_
;

105 
	gev’ts_
;

106 
Ev’tC®lback
 
	gcb_
;

107 *
	gcb_¬g_
;

109 
	g´iv©e
:

110 
Ev’t
() {};

111 
Ev’t
(Event&){};

112 
	gEv’t
& 
	gİ”©Ü
=(
Ev’t
&){};

	@event_engine.cpp

18 
	~"ev’t_’gše.hµ
"

20 
	~<•Şl.h
>

22 
Çme¥aû
 
	gZXBNF
 {

24 
	gEv’tEngše
::
Run
() {

26 
•Şl_ev’t
 
ev
[
kMaxEpŞl
];

27 
	gev_num
 = 0;

28 
	g”rÜ
 = 0;

30 
	gl_»³©
:

33 
Ãxt_wake
 = 0;

34 
timev®
 
	gnow
;

35 
g‘timeofday
(&
now
, 0);

36 
Tim”
 *
	gfœ¡_tim”
 = 
tim”_queue_
.
äÚt
();

37 
	gÃxt_wake
 = (
fœ¡_tim”
->
fœe_time
().
tv_£c
 - 
now
.tv_sec) * 1000;

38 
	gÃxt_wake
 +ğ(
fœ¡_tim”
->
fœe_time
().
tv_u£c
 - 
now
.tv_usec) / 1000;

40 
	gev_num
 = 
kMaxEpŞl
;

41 
	g»t
 = 
•Şl_wa™
(
•Şl_fd_
, &
ev
, 
ev_num
, 
Ãxt_wake
);

42 ià(
	g»t
 == 0) {

43 
Tim”
 *
t
 = 
tim”_queue_
.
äÚt
();

44 
	gtim”_queue_
.
pİ
();

45 ià(
	gt
->
HªdËr
() == 0) {

46 
tim”_queue_
.
push
(
t
);

48 
d–‘e
 
	gt
;

50 
	gl_»³©
;

53 ià(
	g»t
 < 0) {

54 ià(
	g”ºo
 =ğ
EAGAIN
 || 
”ºo
 =ğ
EINTR
) {

57 
	g”rÜ
 = -1;

58 
	gl_ex™
;

61 
	gi
 = 0; i < 
	gev_num
; i++) {

62 
as£¹
(
ev
[
i
].
d©a
.
±r
);

63 
Ev’t
 *
	ge
 = 
»š‹½»t_ÿ¡
<Ev’t*>(
ev
[
i
].
d©a
.
±r
);

64 
	ge
->
£t_•Şl_ev’ts
(
ev
[
i
].
ev’ts
);

65 ià(
	ge
->
HªdËr
() <= 0) {

66 
D–‘eEv’t
(
e
->
fd
());

67 
d–‘e
 
	ge
;

70 
	gev
[
i
].
	gev’ts
 = 
e
->
g‘_•Şl_ev’ts
();

71 
	ge
->
ModEv’t
(
e
);

73 
	gl_»³©
;

75 
	gl_ex™
:

76  
”rÜ
;

79 
	gEv’tEngše
::
AddEv’t
(
Ev’t
 *
e
) {

81 
•Şl_ev’t
 
ev
;

82 
mem£t
(&
ev
, (
e
), 0);

83 
	gev
.
	gev’ts
 = 
e
->
g‘_•Şl_ev’ts
();

84 
	gev
.
	gd©a
.
	g±r
 = 
e
;

85 ià(
•Şl_ùl
(
•Şl_fd_
, 
EPOLL_CTL_ADD
, 
e
->
fd
(), &
ev
) < 0) {

86 ià(
	g”ºo
 =ğ
EEXIST
) {

95 
	gEv’tEngše
::
D–‘eEv’t
(
fd
) {

97 ià(
•Şl_ùl
(
•Şl_fd_
, 
EPOLL_CTL_DEL
, 
fd
, 0) < 0) {

98 ià(
	g”ºo
 =ğ
ENOENT
) {

107 
	gEv’tEngše
::
In™
() {

109 
•Şl_fd_
 = 
•Şl_ü—‹
(
kMaxEpŞl
);

110 ià(
	g•Şl_fd_
 < 0) {

113  
	g•Şl_fd_
;

	@event_engine.hpp

18 #iâdeà
__EVENT_ENGINE_HPP__


19 
	#__EVENT_ENGINE_HPP__


	)

21 
	#EVENT_READ
 0x00000001U

	)

22 
	#EVENT_WRITE
 0x00000002U

	)

23 
	#EVENT_ERROR
 0x00000004U

	)

25 
Çme¥aû
 
	gZXBNF
 {

27 şas 
	cEv’tEngše
 {

28 
	gpublic
:

29 
Ev’tEngše
(è: 
•Şl_fd_
(0), 
tim”_queue_
(100) {};

31 
	gpublic
:

32 
In™
();

33 
Run
();

34 
AddEv’t
(
Ev’t
 *
e
);

35 
ModEv’t
(
Ev’t
 *
e
);

36 
D–‘eEv’t
(
fd
);

38 
šlše
 
AddTim”
(
Tim”
 *
tim”
) {

39 
	gtim”_queue_
.
push
(
tim”
);

41 
šlše
 
Tim”
* 
D–‘eTim”
(
id
) {

42 
Tim”
 *
	g»t
 = 
tim”_queue_
.
äÚt
();

43 
	gtim”_queue_
.
pİ
();

44  
	g»t
;

46 
	g´iv©e
:

47 
´iÜ™y_queue
<
Tim”
*, 
	g¡d
::
veùÜ
<Tim”*>, 
	gTim”Com·»
> 
	gtim”_queue_
;

48 
	g•Şl_fd_
;

49 cÚ¡ 
	gkMaxEpŞl
 = 1024 * 1024;

	@sample_lv_biz.cpp

1 
	~"£rv”.hµ
"

3 şas 
	cUDPChªÃl1Ev’t
 : 
public
 
Ev’t
 {

4 
public
:

5 
	$UDPChªÃl1Ev’t
(
S”v”
 *
¤v
è: 
	$¤v_
(
¤v
) {};

6 ~
	$UDPChªÃl1Ev’t
(){
	}
};

7 
vœtu®
 
	$Ev’tC®lback
() {

8 
»t
 = 0;

9 ià(
	`is_»adabË
()) {

12 
	}
};

14 
	g´iv©e
:

15 
S”v”
 *
¤v_
;

18 şas 
	cTCPLVChªÃl1Ev’t
 : 
public
 
Ev’t
 {

19 
public
:

20 
	$TCPLVChªÃl1Ev’t
(
S”v”
 *
¤v
è: 
	$¤v_
(
¤v
) {};

21 ~
	$TCPLVChªÃl1Ev’t
(){
	}
};

22 
vœtu®
 
	$Ev’tC®lback
() {

23 
»t
 = 0;

24 ià(
	`is_»adabË
()) {

27 
	}
};

29 
	g´iv©e
:

30 
S”v”
 *
¤v_
;

32 şas 
	cTCPLVLi¡’ChªÃl1Ev’t
 : 
public
 
Ev’t
 {

33 
public
:

34 
	$TCPLVLi¡’ChªÃl1Ev’t
(
S”v”
 *
¤v
, 
šdex
è: 
	$¤v_
(
¤v
) {};

35 ~
	$TCPLVLi¡’ChªÃl1Ev’t
(){
	}
};

36 
vœtu®
 
	$Ev’tC®lback
() {

37 
»t
 = 0;

38 ià(
	`is_»adabË
()) {

41 
	}
};

43 
	g´iv©e
:

44 
S”v”
 *
¤v_
;

	@server.cpp

18 
	~"£rv”.hµ
"

20 
Çme¥aû
 
	gZXBNF
 {

22 
	gS”v”
::
AddTCPLVLi¡’Sock‘
(
šdex
, *
¡r
, 
hpÜt
) {

24 
as£¹
(
šdex
 >= 0);

25 
as£¹
(
¡r
);

27 
Add»ss
 
	gaddr
;

28 ià(
	gaddr
.
S‘Add»ss
(
¡r
, 
hpÜt
) != 0) {

32 
AsyncTCPLVLi¡’Sock‘
 *
	gÃwsk
 = 
Ãw
 AsyncTCPLVLi¡’Sock‘(
addr
);

33 ià(
	gÃwsk
->
Li¡’
() < 0) {

37 
Ev’t
 *
	ge
 = 
Ãw
 Ev’t(
Ãwsk
->
sock‘
(), 
Ev’tC®lback_FÜ_TCPLi¡’Sock‘
, 
this
);

38 
	gev’t_’gše_
.
AddEv’t
(
e
);

39 
	gli¡’_sock‘s_
[
šdex
] = 
Ãwsk
->
sock‘
();

40 ià(
	gÃwsk
->
sock‘
(è>ğ
®l_tı_sock‘s_
.
size
()) {

43 
	g®l_tı_sock‘s_
[
Ãwsk
->
sock‘
()] =‚ewsk;

47 
	gS”v”
::
AddTCPLVCl›ÁSock‘
(
šdex
, *
¡r
, 
hpÜt
) {

49 
as£¹
(
šdex
 >= 0);

50 
as£¹
(
¡r
);

52 
Add»ss
 
	gaddr
;

53 ià(
	gaddr
.
S‘Add»ss
(
¡r
, 
hpÜt
) != 0) {

57 
AsyncTCPLVD©aSock‘
 *
	gÃwsk
 = 
Ãw
 AsyncTCPLVDataSocket();

58 ià(
	gÃwsk
->
sock‘
(è>ğ
®l_tı_sock‘s_
.
size
()) {

61 ià(
	gÃwsk
->
CÚÃùTo
(
addr
) < 0) {

65 
Ev’t
 *
	ge
 = 
Ãw
 Ev’t(
Ãwsk
->
sock‘
(), 
Ev’tC®lback_FÜ_TCPCl›ÁSock‘CÚÃù
, 
this
);

66 
	gev’t_’gše_
.
AddEv’t
(
e
);

68 
	g®l_tı_sock‘s_
[
Ãwsk
->
sock‘
()] =‚ewsk;

72 
	gS”v”
::
AddUDPS”v”Sock‘
(*
¡r
, 
hpÜt
) {

74 
	gS”v”
::
AddUDPCl›ÁSock‘
(*
¡r
, 
hpÜt
) {

76 
	gS”v”
::
OnSock‘E¼Ü
(
sock‘
) {

78 
S”v”
::
OnSock‘R—dabË
(
sock‘
) {

80 
S”v”
::
OnSock‘Wr™abË
(
sock‘
) {

	@server.hpp

18 #iâdeà
__SERVER_HPP__


19 
	#__SERVER_HPP__


	)

21 
	~"ev’t_’gše.hµ
"

23 
Çme¥aû
 
	gZXBNF
 {

25 şas 
	cS”v”
 {

26 
	gpublic
:

27 
S”v”
()

28 :
idË_ş›Á_sock‘s_
(
kMaxBack’dNum
),

29 
®l_tı_sock‘s_
(
kMaxSock‘Num
),

30 
udp_£rv”_sock‘_
(-1),

31 
udp_ş›Á_sock‘_
(-1) {

34 ~
S”v”
(){};

35 
	gpublic
:

36 
Ev’tC®lback_FÜ_TCPLi¡’Sock‘
(
Ev’t
 *
e
, *
¬g
);

37 
Ev’tC®lback_FÜ_TCPD©aSock‘
(
Ev’t
 *
e
, *
¬g
);

38 
Ev’tC®lback_FÜ_UDPSock‘
(
Ev’t
 *
e
, *
¬g
);

39 
Ev’tC®lback_FÜ_TCPCl›ÁSock‘CÚÃù
(
Ev’t
 *
e
, *
¬g
);

41 
	gpublic
:

43 
public
:

44 
vœtu®
 
AddTCPLi¡’Sock‘
(*
¡r
, 
hpÜt
);

45 
vœtu®
 
AddTCPCl›ÁSock‘
(
šdex
, *
¡r
, 
hpÜt
);

46 
vœtu®
 
ProûssMes§ge
(
Bufãr
 *
bufãr
, 
size
);

47 
vœtu®
 
ProûssMes§geUDP
(
Bufãr
 *
bufãr
, 
size
);

49 
AddUDPS”v”Sock‘
(*
¡r
, 
hpÜt
);

50 
AddUDPCl›ÁSock‘
(*
¡r
, 
hpÜt
);

52 
	gpublic
:

53 
AsyncTCPD©aSock‘
* 
G‘IdËTCPCl›ÁSock‘
(
šdex
);

54 
R‘uºTCPCl›ÁSock‘
(
fd
);

55 
AsyncTCPSock‘
* 
G‘TCPSock‘
(
fd
);

56 
De¡royTCPSock‘
(
fd
);

58 
	g´iv©e
:

59 
li¡’_sock‘_
;

61 
	g¡d
::
veùÜ
<
¡d
::
li¡
<> > 
idË_ş›Á_sock‘s_
;

62 
	g¡d
::
li¡
<> 
idË_£rv”_sock‘s_
;

63 
	gudp_ş›Á_sock‘_
;

64 
	gudp_£rv”_sock‘_
;

66 
	g¡d
::
veùÜ
<
AsyncTCPSock‘
*> 
®l_tı_sock‘s_
;

68 
	g´iv©e
:

69 
Ev’tEngše
 *
’gše_
;

71 
	g´iv©e
:

72 cÚ¡ 
kMaxBack’dNum
 = 100;

73 cÚ¡ 
	gkMaxCl›ÁSock‘NumP”Back’d
 = 100;

74 cÚ¡ 
	gkMaxS”v”Sock‘Num
 = 1000000;

75 cÚ¡ 
	gkMaxSock‘Num
 = 
kMaxS”v”Sock‘Num
 + 
kMaxBack’dNum
 * 
kMaxCl›ÁSock‘NumP”Back’d
;

	@tcp_server.cpp

18 
	~"tı_£rv”.hµ
"

20 
Çme¥aû
 
	gZXBNF
 {

22 
	gTCPS”v”
::
Ev’tC®lback_FÜ_Li¡’Sock‘
(
Ev’t
 *
e
, *
¬g
) {

24 
as£¹
(
e
);

25 
as£¹
(
¬g
);

26 
TCPS”v”
 *
	g¤v
 = 
»š‹½»t_ÿ¡
<TCPS”v”*>(
¬g
);

28 
as£¹
(!
e
->
is_wr™abË
());

29 
as£¹
(!
e
->
is_şo£d
());

31 ià(
	ge
->
is_”rÜ
()) {

32 
	g¤v
->
Re¡¬t
(1000);

35 ià(!
	ge
->
is_»adabË
()) {

38 
	gli¡’_fd
 = 
e
->
sock‘
();

39 
	gŒue
) {

40 
sockaddr_š
 
	gÃw_addr
;

41 
sockËn_t
 
	gËn
 = 0;

42 
	gÃwfd
 = 
acû±
(
li¡’_fd
, (
sockaddr
*)&
Ãw_addr
, &
Ën
);

43 ià(
	gÃwfd
 < 0) {

44 ià(
	g”ºo
 =ğ
EAGAIN
 || 
”ºo
 =ğ
EINTR
) {

47 
	g¤v
->
Re¡¬t
(1000);

51 
AsyncTCPD©aSock‘
 *
	gÃw_sock‘
 = 
MakeNewSock‘
(
Ãwfd
);

52 ià(
	gÃw_sock‘
) {

53 
	g¤v
->
AddS”v”Sock‘
(
Ãw_sock‘
);

54 
Ev’t
 *
	ge
 = 
Ãw
 Ev’t(
Ãw_sock‘
->
sock‘
(), 
Ev’tC®lback_FÜ_D©aSock‘
, 
¤v
);

55 
	ge
->
£t_»ad_ev’t
();

56 
	g¤v
->
ev’t_’gše
()->
AddEv’t
(
e
);

58 
as£¹
(
çl£
);

63 
	gTCPS”v”
::
Ev’tC®lback_FÜ_D©aSock‘
(
Ev’t
 *
e
, *
¬g
) {

65 
	gTCPS”v”
::
Ev’tC®lback_FÜ_CÚÃù
(
Ev’t
 *
e
, *
¬g
) {

66 
as£¹
(
e
);

67 
as£¹
(
¬g
);

68 
as£¹
(!
e
->
is_»adabË
());

73 
	gTCPS”v”
::
Tim”C®lback_FÜ_Sw“p
(
Tim”
 *
t
, *
¬g
) {

76 
	gTCPS”v”
::
Tim”C®lback_FÜ_NÙhšg
(
Tim”
 *
t
, *
¬g
) {

77 
	gENTERING
;

78 
	gÃxt
 = 5000;

79 
	gLEAVING
;

80  
	gÃxt
;

	@tcp_server.hpp

18 #iâdeà
__TCP_SERVER_HPP__


19 
	#__TCP_SERVER_HPP__


	)

22 
	~"ev’t_’gše.hµ
"

24 
Çme¥aû
 
	gZXBNF
 {

26 şas 
	cTCPS”v”
 {

27 
	gpublic
:

28 
TCPS”v”
(
Ev’tEngše
 *
eg
)

29 : 
ev’t_’gše_
(
eg
),

30 
idË_ş›Á_sock‘s_
(
kMaxBack’dNum
),

31 
®l_tı_sock‘s_
(
kMaxSock‘Num
) {

34 ~
TCPS”v”
(){};

35 
šlše
 
Ev’tEngše
* 
ev’t_’gš
(è{  
	gev’t_’gše_
; };

36 
	gpublic
:

41 
Ev’tC®lback_FÜ_Li¡’Sock‘
(
Ev’t
 *
e
, *
¬g
);

42 
Ev’tC®lback_FÜ_D©aSock‘
(
Ev’t
 *
e
, *
¬g
);

43 
Ev’tC®lback_FÜ_CÚÃù
(
Ev’t
 *
e
, *
¬g
);

45 
	gpublic
:

46 
Tim”C®lback_FÜ_Sw“p
(
Tim”
 *
t
, *
¬g
);

47 
Tim”C®lback_FÜ_NÙhšg
(
Tim”
 *
t
, *
¬g
);

48 
	g´iv©e
:

49 
AddS”v”Sock‘
(
AsyncTCPD©aSock‘
 *
sk
) {

50 ià(
sk
->
sock‘
(è>ğ
®l_tı_sock‘s_
.
size
()) {

53 
	g£rv”_sock‘s_
.
push_back
(
sk
);

54 
	g®l_tı_sock‘s_
[
sk
->
sock‘
()] = sk;

57 
	gpublic
:

58 
vœtu®
 
AddLi¡’Sock‘
(*
¡r
, 
hpÜt
) = 0;

59 
vœtu®
 
AddCl›ÁSock‘
(
back’d_šdex
, *
¡r
, 
hpÜt
) = 0;

60 
vœtu®
 
ProûssMes§ge
(
Bufãr
 *
bufãr
, 
size
) = 0;

62 
	gpublic
:

63 
A‰©chEngše
(
Ev’tEngše
 *
eg
è{ 
ev’t_’gše_
 =ƒg; };

64 
	gpublic
:

65 
AsyncTCPD©aSock‘
* 
G‘IdËCl›ÁSock‘
(
back’d_šdex
) {

66 
as£¹
(
back’d_šdex
 < 
idË_ş›Á_sock‘s_
.
size
());

67 
AsyncTCPD©aSock‘
 *
	g»t
 = 
idË_ş›Á_sock‘s_
[
back’d_šdex
].
äÚt
();

68 ià(
	g»t
) {

69 
	gidË_ş›Á_sock‘s_
[
back’d_šdex
].
pİ
();

71  
	g»t
;

74 
R‘uºCl›ÁSock‘
(
back’d_šdex
, 
fd
) {

75 
as£¹
(
back’d_šdex
 < 
idË_ş›Á_sock‘s_
.
size
());

76 
	gidË_ş›Á_sock‘s_
[
back’d_šdex
].
push_back
(
fd
);

78 
AsyncTCPSock‘
* 
G‘Sock‘
(
fd
) {

79 
as£¹
(
fd
 < 
®l_tı_sock‘s_
.
size
());

80  
	g®l_tı_sock‘s_
[
fd
];

82 
De¡roySock‘
(
fd
) {

83 
as£¹
(
fd
 < 
®l_tı_sock‘s_
.
size
());

84 
as£¹
(
®l_tı_sock‘s_
[
fd
]);

85 
d–‘e
 
	g®l_tı_sock‘s_
[
fd
];

86 
	g®l_tı_sock‘s_
[
fd
] = 0;

89 
	g´iv©e
:

90 
li¡’_sock‘_
;

92 
	g¡d
::
veùÜ
<
¡d
::
li¡
<> > 
idË_ş›Á_sock‘s_
;

93 
	g¡d
::
li¡
<> 
£rv”_sock‘s_
;

94 
	g¡d
::
veùÜ
<
AsyncTCPSock‘
*> 
®l_tı_sock‘s_
;

96 
	g´iv©e
:

97 
Ev’tEngše
 *
’gše_
;

99 
	g´iv©e
:

100 cÚ¡ 
kMaxBack’dNum
 = 100;

101 cÚ¡ 
	gkMaxCl›ÁSock‘NumP”Back’d
 = 100;

102 cÚ¡ 
	gkMaxS”v”Sock‘Num
 = 1000000;

103 cÚ¡ 
	gkMaxSock‘Num
 = 
kMaxS”v”Sock‘Num
 + 
kMaxBack’dNum
 * 
kMaxCl›ÁSock‘NumP”Back’d
;

	@timer.hpp

19 #iâdeà
__TIMER_HPP__


20 
	#__TIMER_HPP__


	)

23 
Çme¥aû
 
	gZXBNF
 {

25 
	sTim”Com·»
 {

26 
boŞ
 
İ”©Ü
()(
Tim”
 *
	gt1
, Tim” *
	gt2
) {

27 ià(
	gt1
->
fœe_time
().
	gtv_£c
 > 
	gt2
->fire_time().tv_sec) {

28  
	gŒue
;

29 } ià(
	gt1
->
fœe_time
().
	gtv_£c
 =ğ
t2
->fœe_time().
tv_£c
) {

30 ià(
t1
->
fœe_time
().
tv_u£c
 > 
t2
->fire_time().tv_usec) {

31  
Œue
;

36  
	gçl£
;

40 şas 
	cTim”
 {

41 
	gpublic
:

46 (*
Tim”C®lback
)(
	tTim”
*, *);

48 
Tim”
(
id
, 
Tim”C®lback
 
cb
, *
¬g
)

49 :
id_
(
id
),

50 
cb_
(
cb
),

51 
cb_¬g_
(
¬g
) {};

53 
	gvœtu®
 ~
Tim”
(){};

55 
šlše
 
id
(è{  
	gid_
; };

56 
šlše
 
timev®
 cÚ¡ &
fœe_time
(è{  
	gfœe_time_
; };

57 
S‘Tim”
(
m£c
) {

59 
as£¹
(
m£c
 > 0);

60 
g‘timeofday
(&
fœe_time_
, 0);

62 
	gs
 = (
fœe_time_
.
tv_u£c
 + 
m£c
) / 1000000;

63 
	gu
 = (
fœe_time_
.
tv_u£c
 + 
m£c
) % 1000000;

65 
	gfœe_time_
.
	gtv_£c
 +ğ
s
;

66 
	gfœe_time_
.
	gtv_u£c
 = 
u
;

75 
HªdËr
() {

76 
timev®
 
	gnow
;

77 
g‘timeofday
(&
now
, 0);

78 ià(
	gÃxt_time_
.
	gtv_£c
 > 
	gnow
.tv_sec) {

81 ià(
	gÃxt_time_
.
	gtv_£c
 =ğ
now
.
tv_£c
) {

82 ià(
Ãxt_time_
.
tv_u£c
 - 
now
.tv_usec > 10000) {

86 
	gm£c
 = 
cb_
();

87 ià(
	gm£c
 < 0) {

90 ià(
	gm£c
 == 0) {

93 
S‘Tim”
(
m£c
);

97 
	g´iv©e
:

98 
id_
;

99 
timev®
 
	gfœe_time_
;

100 
Tim”C®lback
 
	gcb_
;

101 *
	gcb_¬g_
;

	@udp_server.hpp

18 #iâdeà
__UDP_SERVER_HPP__


19 
	#__UDP_SERVER_HPP__


	)

21 
	~"ev’t_’gše.hµ
"

23 
Çme¥aû
 
	gZXBNF
 {

25 şas 
	cUDPS”v”
 {

26 
	gpublic
:

27 
UDPS”v”
()

28 
udp_£rv”_sock‘_
(-1),

29 
udp_ş›Á_sock‘_
(-1) {

32 ~
UDPS”v”
(){};

33 
	gpublic
:

34 
Ev’tC®lback_FÜ_UDPSock‘
(
Ev’t
 *
e
, *
¬g
);

35 
	gpublic
:

36 
Tim”C®lback_FÜ_NÙhšg
(
Tim”
 *
t
, *
¬g
);

37 
	gpublic
:

38 
vœtu®
 
ProûssMes§ge
(
Bufãr
 *
bufãr
, 
size
);

40 
AddUDPS”v”Sock‘
(*
¡r
, 
hpÜt
);

41 
AddUDPCl›ÁSock‘
(*
¡r
, 
hpÜt
);

43 
	g´iv©e
:

44 
udp_ş›Á_sock‘_
;

45 
	gudp_£rv”_sock‘_
;

46 
	g´iv©e
:

47 
Ev’tEngše
 *
’gše_
;

	@util.hpp

18 #iâdeà
__UTIL_HPP__


19 
	#__UTIL_HPP__


	)

21 
	~<¡ršg.h
>

22 
	~<¡dlib.h
>

23 
	~<¡dio.h
>

24 
	~<¡ršg
>

25 
	~<s¡»am
>

26 
	~<veùÜ
>

27 
	~<c¡dio
>

29 
Çme¥aû
 
	gZXBNF
 {

31 şas 
	cTimeUt
 {

32 
	gpublic
:

33 
TimeToSŒšg
(
time_t
 
time_£c
, 
¡d
::
¡ršg
 &
time_¡r
) {

35 ià(
time_£c
 < 0) {

39 
tm
 *
	g¶oÿÉime
 = 
loÿÉime
(&
time_£c
);

40 
	g¡d
::
veùÜ
<> 
buf
;

41 
	gbuf
.
»size
(100);

42 
size_t
 
	g»t
 = 
¡ráime
(&
buf
[0], buf.
size
(), "%Y-%m-%d %H:%M:%S", 
¶oÿÉime
);

43 ià(
	g»t
 == 0) {

46 
	gtime_¡r
.
assign
(&
buf
[0], 
»t
);

50 
Cu¼’tTimeSŒšg
(
¡d
::
¡ršg
 &
time_¡r
) {

52 
time_t
 
cu¹ime
 = 
time
(0);

53 ià(
	gcu¹ime
 == -1) {

56 
	g»t
 = 
TimeToSŒšg
(
cu¹ime
, 
time_¡r
);

57  
	g»t
;

60 
SŒšgToTime
(
¡d
::
¡ršg
 &
time_¡r
, 
time_t
 &
time_£c
) {

62 
tm
 
	gloÿl_time
;

63 
mem£t
(&
loÿl_time
, 0, (local_time));

64 
size_t
 
	g»t
 = 
ssÿnf
(
time_¡r
.
c_¡r
(), "%d-%d-%d %d:%d:%d",

65 &
loÿl_time
.
tm_y—r
, &loÿl_time.
tm_mÚ
, &loÿl_time.
tm_mday
,

66 &
loÿl_time
.
tm_hour
, &loÿl_time.
tm_mš
, &loÿl_time.
tm_£c
);

68 ià(
	g»t
 =ğ0U || 
»t
 != 6U) {

72 
	gloÿl_time
.
	gtm_y—r
 -= 1900;

73 
	gloÿl_time
.
	gtm_mÚ
 -= 1;

74 
	gloÿl_time
.
	gtm_isd¡
 = 0;

76 
	gtime_£c
 = 
mktime
(&
loÿl_time
);

80 
	g´iv©e
:

81 
TimeUt
();

82 
TimeUt
(TimeUtil&);

85 
	#SLOG_LEVEL
 0xFFFFFFFFUL

	)

87 #ià!
	$defšed
(
SLOG
)

88 
	#SLOG
(
Ëv–
,
fÜm©
,
¬g
...) \

90 ià((
Ëv–
è& 
SLOG_LEVEL
) { \

91 
¡d
::
¡ršg
 
time¡r
; \

92 
TimeUt
::
	`Cu¼’tTimeSŒšg
(
time¡r
); \

93 
	`årštf
(
¡d”r
, "%lu % % % %d "
fÜm©
, 
	`±h»ad_£lf
(), \

94 
time¡r
.
	`c_¡r
(), 
__func__
, \

95 
__FILE__
, 
__LINE__
, ##
¬g
); \

97 
	}
} 0)

	)

100 
	#ENTERING
 
	`SLOG
(1, "EÁ”\n");

	)

101 
	#LEAVING
 
	`SLOG
(1, "L—ve\n");

	)

102 
	#LEAVING2
 
	`SLOG
(1, "L—vÚƒ¼Ü\n");

	)

105 
	}
};

	@
1
.
0
19
289
address.hpp
async_http_socket.hpp
async_lv_socket.hpp
async_socket.cpp
async_socket.hpp
async_tcp_socket.hpp
async_udp_socket.hpp
buffer.hpp
event.hpp
event_engine.cpp
event_engine.hpp
sample_lv_biz.cpp
server.cpp
server.hpp
tcp_server.cpp
tcp_server.hpp
timer.hpp
udp_server.hpp
util.hpp
